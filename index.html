<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ресторан AR & Taste</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
  :root {
    --bg-dark: #071022;
    --card-dark: #0b1220;
    --text-dark: #e6eef8;
    --muted-dark: #9fb0c9;
    --accent-dark: #ff7a18;

    --bg-light: #f7fafc;
    --card-light: #ffffff;
    --text-light: #0b1220;
    --muted-light: #607089;
    --accent-light: #ff6b35;
  }
  html {
    transition: background 0.2s linear, color 0.2s linear;
  }
  body {
    margin: 0;
    font-family: Inter, system-ui, Arial, sans-serif;
    min-height: 100vh;
    background: var(--bg);
    color: var(--text);
    transition: background 0.25s linear, color 0.25s linear;
  }
  .light {
    --bg: var(--bg-light);
    --card: var(--card-light);
    --text: var(--text-light);
    --muted: var(--muted-light);
    --accent: var(--accent-light);
  }
  .dark {
    --bg: var(--bg-dark);
    --card: var(--card-dark);
    --text: var(--text-dark);
    --muted: var(--muted-dark);
    --accent: var(--accent-dark);
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 20px;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
    backdrop-filter: blur(6px);
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .logo {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: linear-gradient(180deg, var(--accent), #ffb28b);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    color: #071022;
    user-select: none;
  }
  .title h1 {
    margin: 0;
    font-size: 18px;
  }
  .title p {
    margin: 0;
    font-size: 13px;
    color: var(--muted);
  }

  main.container {
    max-width: 1100px;
    margin: 28px auto;
    padding: 0 18px;
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
    gap: 18px;
  }
  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 12px;
    overflow: hidden;
    box-shadow: 0 6px 26px rgba(2,6,23,0.5);
    transition: transform 0.28s cubic-bezier(.2,.9,.3,1), box-shadow 0.28s, filter 0.28s;
    cursor: pointer;
  }
  .card:hover {
    transform: translateY(-10px) scale(1.01);
    box-shadow: 0 30px 60px rgba(2,6,23,0.55);
    filter: saturate(1.05);
  }
  .card img {
    width: 100%;
    height: 170px;
    object-fit: cover;
    border-radius: 8px;
  }
  .meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
  }
  .price {
    font-weight: 800;
  }

  button.btn {
    padding: 8px 12px;
    border-radius: 10px;
    border: 0;
    cursor: pointer;
    font-weight: 700;
    transition: transform 0.12s ease, box-shadow 0.12s;
  }
  button.btn:active {
    transform: scale(0.98);
  }
  button.btn-primary {
    background: linear-gradient(90deg, var(--accent), #ffb28b);
    color: #071022;
  }
  button.btn-ghost {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--muted);
  }

  .cart-btn {
    position: relative;
  }
  .cart-count {
    position: absolute;
    top: -6px;
    right: -6px;
    background: var(--accent);
    color: #071022;
    border-radius: 999px;
    padding: 4px 7px;
    font-size: 12px;
    font-weight: 800;
    user-select: none;
  }

  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: linear-gradient(180deg, rgba(1,2,6,0.6), rgba(1,2,6,0.85));
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 60;
    animation: pop 0.18s ease;
  }
  .modal-panel {
    width: min(980px,95%);
    background: var(--card);
    border-radius: 14px;
    padding: 18px;
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
    align-items: start;
  }
  @keyframes pop {
    from {opacity: 0; transform: translateY(8px) scale(0.99);}
    to {opacity: 1; transform: none;}
  }
  .dish-img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 10px;
  }
  .dish-title {
    margin: 0;
    font-size: 20px;
  }
  .dish-desc {
    color: var(--muted);
    margin-top: 8px;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 12px;
  }
  .status-badge {
    display: inline-block;
    padding: 6px 8px;
    border-radius: 8px;
    font-size: 13px;
  }
  .note {
    color: var(--muted);
    margin-top: 10px;
  }

  /* responsive */
  @media (max-width: 820px) {
    .modal-panel {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body class="dark">

<header>
  <div class="brand">
    <div class="logo">R</div>
    <div class="title">
      <h1>Ресторан «AR & Taste»</h1>
      <p>Меню • AR-просмотр блюд</p>
    </div>
  </div>

  <div style="display:flex;align-items:center;gap:10px;">
    <button id="theme-toggle" class="btn btn-ghost" title="Переключить тему">☀️ Светлая</button>

    <button id="cart-btn" class="btn btn-ghost cart-btn" title="Корзина">
      Корзина <span id="cart-count" class="cart-count" style="display:none;">0</span>
    </button>
  </div>
</header>

<main class="container">
  <section style="margin-bottom:14px;">
    <h2 style="margin:0;">Наше меню</h2>
    <p style="color:var(--muted);margin-top:6px;">Нажмите “Подробнее”, чтобы открыть мини-страницу блюда с AR-просмотром и добавить в корзину.</p>
  </section>

  <section id="menu-grid" class="menu-grid"></section>

  <aside id="cart-preview" style="margin-top:22px;display:none;justify-content:flex-end;">
    <div style="background:var(--card);padding:12px;border-radius:12px;min-width:220px;box-shadow:0 8px 24px rgba(2,6,23,0.4);">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800;">Корзина</div>
        <div id="cart-items-count" style="color:var(--muted);">0 шт</div>
      </div>
      <div id="cart-total" style="margin-top:8px;color:var(--muted);">Итого: <strong>€0.00</strong></div>
      <div style="margin-top:10px;display:flex;gap:8px;">
        <button id="order-btn" class="btn btn-primary">Оформить</button>
        <button id="clear-cart-btn" class="btn btn-ghost">Очистить</button>
      </div>
    </div>
  </aside>
</main>

<!-- Модальное окно -->
<div id="modal" class="modal-backdrop" style="display:none;">
  <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div>
      <img id="modal-img" class="dish-img" src="" alt="" />
    </div>
    <div>
      <h3 id="modal-title" class="dish-title"></h3>
      <div id="modal-price" style="color:var(--muted);margin-top:6px;"></div>
      <p id="modal-desc" class="dish-desc"></p>

      <model-viewer
        id="model-viewer"
        style="width: 100%; height: 320px; border-radius: 8px; background: #081226;"
        alt=""
        camera-controls
        ar
        ar-modes="webxr scene-viewer quick-look"
        poster=""
      ></model-viewer>

      <div class="modal-actions">
        <a id="ar-link" class="btn btn-ghost" href="#" rel="ar" target="_blank">Открыть в AR (iPhone)</a>
        <button id="add-to-cart-btn" class="btn btn-primary">Добавить в корзину</button>
        <button id="close-modal-btn" class="btn btn-ghost">Закрыть</button>
      </div>

      <div id="model-status" class="note">Статус 3D: idle</div>
      <div id="model-error" class="note" style="color:#ffb3b3; display:none; margin-top:10px;">Ошибка загрузки модели — проверьте URL и доступность файла (HTTPS).</div>
      <div class="note">Совет: для iPhone используйте Safari и убедитесь, что сайт доступен по HTTPS; для Android — требуется поддержка WebXR / Scene Viewer.</div>
    </div>
  </div>
</div>

<script>
(() => {
  const MENU = [
    {
      id: "m1",
      name: "Маргарита",
      price: 9.5,
      image: "https://images.unsplash.com/photo-1601924638867-3b6d8ec9a8fa?auto=format&fit=crop&w=800&q=80",
      description: "Классическая пицца Маргарита — томатный соус, моцарелла, базилик.",
      modelGlb: "https://modelviewer.dev/shared-assets/models/Pizza.glb",
      modelUsdz: "https://modelviewer.dev/shared-assets/models/Pizza.usdz",
    },
    {
      id: "m2",
      name: "Пепперони",
      price: 11.0,
      image: "https://images.unsplash.com/photo-1548365328-98d5a8778b69?auto=format&fit=crop&w=800&q=80",
      description: "Острая пепперони с хрустящей корочкой и тянущимся сыром.",
      modelGlb: "https://modelviewer.dev/shared-assets/models/Pizza.glb",
      modelUsdz: "https://modelviewer.dev/shared-assets/models/Pizza.usdz",
    },
    {
      id: "s1",
      name: "Цезарь с курицей",
      price: 8.0,
      image: "https://images.unsplash.com/photo-1600891964599-f61ba0e24092?auto=format&fit=crop&w=800&q=80",
      description: "Свежий салат Цезарь с жареной курицей и пармезаном.",
      modelGlb: "https://modelviewer.dev/shared-assets/models/Pizza.glb",
      modelUsdz: "https://modelviewer.dev/shared-assets/models/Pizza.usdz",
    },
  ];

  // Элементы DOM
  const menuGrid = document.getElementById("menu-grid");
  const modal = document.getElementById("modal");
  const modalImg = document.getElementById("modal-img");
  const modalTitle = document.getElementById("modal-title");
  const modalPrice = document.getElementById("modal-price");
  const modalDesc = document.getElementById("modal-desc");
  const modelViewer = document.getElementById("model-viewer");
  const arLink = document.getElementById("ar-link");
  const addToCartBtn = document.getElementById("add-to-cart-btn");
  const closeModalBtn = document.getElementById("close-modal-btn");
  const modelStatus = document.getElementById("model-status");
  const modelError = document.getElementById("model-error");

  const cartBtn = document.getElementById("cart-btn");
  const cartCount = document.getElementById("cart-count");
  const cartPreview = document.getElementById("cart-preview");
  const cartItemsCount = document.getElementById("cart-items-count");
  const cartTotal = document.getElementById("cart-total");
  const orderBtn = document.getElementById("order-btn");
  const clearCartBtn = document.getElementById("clear-cart-btn");

  const themeToggle = document.getElementById("theme-toggle");
  const body = document.body;

  // ===== Работа с темой =====
  function setTheme(theme) {
    if (theme === "light") {
      body.classList.remove("dark");
      body.classList.add("light");
      themeToggle.textContent = "🌙 Тёмная";
    } else {
      body.classList.remove("light");
      body.classList.add("dark");
      themeToggle.textContent = "☀️ Светлая";
    }
    localStorage.setItem("ar_theme", theme);
  }

  // Инициализация темы из localStorage
  const savedTheme = localStorage.getItem("ar_theme") || "dark";
  setTheme(savedTheme);

  themeToggle.onclick = () => {
    const newTheme = body.classList.contains("light") ? "dark" : "light";
    setTheme(newTheme);
  };

  // ===== Работа с корзиной =====
  let cart = JSON.parse(localStorage.getItem("ar_cart") || "[]");

  function saveCart() {
    localStorage.setItem("ar_cart", JSON.stringify(cart));
  }

  function updateCartUI() {
    const count = cart.reduce((acc, item) => acc + item.qty, 0);
    cartCount.style.display = count > 0 ? "inline-block" : "none";
    cartCount.textContent = count;

    cartItemsCount.textContent = count + " шт";

    const total = cart.reduce((acc, item) => acc + item.qty * item.price, 0);
    cartTotal.innerHTML = `Итого: <strong>€${total.toFixed(2)}</strong>`;

    cartPreview.style.display = count > 0 ? "flex" : "none";
  }

  function addToCart(dish, qty = 1) {
    const found = cart.find((item) => item.id === dish.id);
    if (found) {
      found.qty += qty;
    } else {
      cart.push({ ...dish, qty });
    }
    saveCart();
    updateCartUI();
  }

  function clearCart() {
    cart = [];
    saveCart();
    updateCartUI();
  }

  orderBtn.onclick = () => {
    alert("Оформление заказа пока не реализовано (демо).");
  };

  clearCartBtn.onclick = () => {
    clearCart();
  };

  cartBtn.onclick = () => {
    alert("Откройте карточку блюда, чтобы добавить в корзину.");
  };

  updateCartUI();

  // ===== Заполнение меню =====
  function createDishCard(dish) {
    const article = document.createElement("article");
    article.className = "card";

    const img = document.createElement("img");
    img.src = dish.image;
    img.alt = dish.name;
    article.appendChild(img);

    const meta = document.createElement("div");
    meta.style.marginTop = "10px";

    const flex = document.createElement("div");
    flex.style.display = "flex";
    flex.style.justifyContent = "space-between";
    flex.style.alignItems = "center";

    const nameDiv = document.createElement("div");
    nameDiv.style.fontWeight = "800";
    nameDiv.textContent = dish.name;
    flex.appendChild(nameDiv);

    const priceDiv = document.createElement("div");
    priceDiv.className = "price";
    priceDiv.textContent = `€${dish.price.toFixed(2)}`;
    flex.appendChild(priceDiv);

    meta.appendChild(flex);

    const desc = document.createElement("p");
    desc.style.color = "var(--muted)";
    desc.style.marginTop = "8px";
    desc.style.fontSize = "14px";
    desc.textContent = dish.description;
    meta.appendChild(desc);

    const buttonsDiv = document.createElement("div");
    buttonsDiv.style.marginTop = "12px";
    buttonsDiv.style.display = "flex";
    buttonsDiv.style.gap = "8px";

    const detailsBtn = document.createElement("button");
    detailsBtn.className = "btn btn-primary";
    detailsBtn.textContent = "Подробнее";
    detailsBtn.onclick = () => openModal(dish);
    buttonsDiv.appendChild(detailsBtn);

    const addBtn = document.createElement("button");
    addBtn.className = "btn btn-ghost";
    addBtn.textContent = "В корзину";
    addBtn.onclick = () => {
      addToCart(dish, 1);
      alert("Добавлено в корзину");
    };
    buttonsDiv.appendChild(addBtn);

    meta.appendChild(buttonsDiv);

    article.appendChild(meta);

    return article;
  }

  function renderMenu() {
    menuGrid.innerHTML = "";
    for (const dish of MENU) {
      menuGrid.appendChild(createDishCard(dish));
    }
  }

  renderMenu();

  // ===== Модальное окно =====
  let currentDish = null;

  function openModal(dish) {
    currentDish = dish;
    modal.style.display = "flex";

    modalImg.src = dish.image;
    modalImg.alt = dish.name;
    modalTitle.textContent = dish.name;
    modalPrice.textContent = `Цена: €${dish.price.toFixed(2)}`;
    modalDesc.textContent = dish.description;

    modelViewer.src = dish.modelGlb;
    modelViewer.poster = dish.image;
    modelViewer.alt = dish.name;

    // Для iPhone AR quick look нужно ссылку на usdz
    arLink.href = dish.modelUsdz;
    arLink.style.display = dish.modelUsdz ? "inline-block" : "none";

    modelError.style.display = "none";
    modelStatus.textContent = "Статус 3D: загрузка...";

    // Подписываемся на события model-viewer
    modelViewer.addEventListener("load", onModelLoaded);
    modelViewer.addEventListener("error", onModelError);
  }

  function closeModal() {
    modal.style.display = "none";
    modelViewer.removeEventListener("load", onModelLoaded);
    modelViewer.removeEventListener("error", onModelError);
    currentDish = null;
  }

  closeModalBtn.onclick = closeModal;
  modal.onclick = (e) => {
    if (e.target === modal) closeModal();
  };

  addToCartBtn.onclick = () => {
    if (currentDish) {
      addToCart(currentDish, 1);
      alert("Добавлено в корзину");
    }
  };

  function onModelLoaded() {
    modelStatus.textContent = "Статус 3D: модель загружена";
    modelError.style.display = "none";
  }
  function onModelError() {
    modelStatus.textContent = "Статус 3D: ошибка загрузки";
    modelError.style.display = "block";
  }
})();
</script>

</body>
</html>
